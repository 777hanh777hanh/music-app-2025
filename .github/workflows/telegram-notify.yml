name: Telegram Notification

on:
  push:
    tags:
      - '*'
    branches:
      - main
      - develop
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches:
      - '*'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get commit details
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=format:%s)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:%an)" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        run: |
          export AUTHOR="${{ steps.commit.outputs.author }}"
          export REPO="${GITHUB_REPOSITORY##*/}"
          export REF="${GITHUB_REF##*/}"
          export COMMIT_MSG="${{ steps.commit.outputs.message }}"
          export REPO_URL="https://github.com/$GITHUB_REPOSITORY"

          # In th√¥ng tin debug ƒë·ªÉ d·ªÖ theo d√µi
          echo "Event: ${{ github.event_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref: $REF"

          # X·ª≠ l√Ω ri√™ng cho t·ª´ng lo·∫°i s·ª± ki·ªán
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # N·∫øu l√† m·ªôt tag ƒë∆∞·ª£c t·∫°o ra
            export MESSAGE="üöÄ New Release%0A%0A<code>$REPO</code>: Tag <code>$REF</code>%0A$COMMIT_MSG%0Aby $AUTHOR%0A%0A$REPO_URL/releases/tag/$REF"

          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "branch" ]]; then
            # N·∫øu l√† push v√†o branch (kh√¥ng ph·∫£i tag)
            export MESSAGE="üìù New Push%0A%0A<code>$REPO</code>: Branch <code>$REF</code>%0A$COMMIT_MSG%0Aby $AUTHOR%0A%0A$REPO_URL/commit/${{ github.sha }}"

          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # N·∫øu l√† pull request
            export PR_TITLE="${{ github.event.pull_request.title }}"
            export PR_URL="${{ github.event.pull_request.html_url }}"
            export PR_NUM="${{ github.event.pull_request.number }}"
            export MESSAGE="üîç New Pull Request #$PR_NUM%0A%0A<code>$REPO</code>%0A$PR_TITLE%0Aby $AUTHOR%0A%0A$PR_URL"

          else
            # Tr∆∞·ªùng h·ª£p kh√°c
            export MESSAGE="‚ö° Repository Activity%0A%0A<code>$REPO</code>%0A$COMMIT_MSG%0Aby $AUTHOR%0A%0A$REPO_URL"
          fi

          # G·ª≠i th√¥ng b√°o
          curl -s -X POST \
            -d "parse_mode=HTML&chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=$MESSAGE" \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage
